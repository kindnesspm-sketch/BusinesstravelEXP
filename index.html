<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNS hotelÂ∑ÆÊóÖË≤ªË®àÁÆóÁ≥ªÁµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
        }

        .custom-btn {
            transition: all 0.2s ease-in-out;
        }

        .custom-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .table-container {
            overflow-x: auto;
        }

        #results-preview {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }

        #results-preview.show {
            max-height: 1000px;
            opacity: 1;
        }

        /* Â†±Ë°® Modal Ê®£Âºè */
        #report-modal-content table,
        #report-modal-content th,
        #report-modal-content td {
            border: 1px solid black;
        }

        @media print {
            @page {
                size: A4 portrait;
                margin: 1cm;
            }

            html,
            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                width: auto !important;
                height: auto !important;
                overflow: visible !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body>*:not(#report-modal) {
                display: none !important;
                visibility: hidden !important;
            }

            #report-modal {
                display: block !important;
                visibility: visible !important;
                position: relative !important;
                background: none !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                inset: auto !important;
                max-width: none !important;
                max-height: none !important;
                overflow: visible !important;
            }

            #report-modal>div {
                visibility: visible !important;
                display: block !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                max-width: none !important;
                max-height: none !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }

            #report-modal-content {
                display: block !important;
                visibility: visible !important;
                width: 100% !important;
                height: auto !important;
                font-size: 10pt;
                line-height: 1.4;
                border: none !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
            }

            #report-modal-content h2 {
                font-size: 14pt;
                margin-bottom: 0.5em;
            }

            #report-modal-content h3 {
                font-size: 12pt;
                margin-bottom: 0.5em;
            }

            #report-print-btn,
            #report-close-btn {
                display: none !important;
            }

            #report-modal-content table {
                font-size: 9pt;
                width: 100%;
                border-collapse: collapse;
                table-layout: auto;
                page-break-inside: auto;
            }

            #report-modal-content th,
            #report-modal-content td {
                padding: 2px 4px;
                word-wrap: break-word;
                height: auto !important;
            }

            #report-modal-content tr {
                page-break-inside: avoid;
                page-break-after: auto;
                height: auto !important;
            }

            #report-modal-content tfoot tr:last-child td {
                min-height: 4em;
                vertical-align: top;
            }

            #report-modal-content div:last-of-type {
                page-break-before: avoid !important;
                margin-top: 1em;
            }
        }
    </style>
</head>

<body class="p-4 bg-gray-100 flex flex-col min-h-screen">

    <div id="capture-area" class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">

        <header class="text-center mb-6">
            <h1 id="main-title" class="text-2xl md:text-3xl font-bold text-gray-800">
                Â∑ÆÊóÖË≤ªÁ¥ÄÈåÑÁ≥ªÁµ±
            </h1>
        </header>

        <main>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4">
                        <p class="text-sm font-bold text-gray-600">Â†±Ë°®Âü∫Êú¨Ë≥áÊñô</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- Row 1 -->
                            <div class="col-span-1">
                                <label for="report-job-title"
                                    class="block text-sm font-medium text-gray-700 mb-1">ËÅ∑Âà•</label>
                                <input type="text" id="report-job-title" placeholder="Â¶ÇÔºöË≥áË®äË™≤"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="col-span-1">
                                <label for="report-name" class="block text-sm font-medium text-gray-700 mb-1">ÂßìÂêç</label>
                                <input type="text" id="report-name" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="col-span-2">
                                <label for="report-trip-location"
                                    class="block text-sm font-medium text-gray-700 mb-1">Âá∫Â∑ÆÂú∞Èªû</label>
                                <input type="text" id="report-trip-location" placeholder="Ë´ãËº∏ÂÖ•Âá∫Â∑ÆÂú∞Èªû"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Row 2 -->
                            <div class="col-span-4">
                                <label for="report-trip-reason"
                                    class="block text-sm font-medium text-gray-700 mb-1">Âá∫Â∑Æ‰∫ãÁî±</label>
                                <input type="text" id="report-trip-reason" placeholder="Ë´ãËº∏ÂÖ•Âá∫Â∑Æ‰∫ãÁî±"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Row 3 -->
                            <div class="col-span-2">
                                <label for="report-trip-start"
                                    class="block text-sm font-medium text-gray-700 mb-1">Âá∫Â∑ÆÊó•ÊúüËµ∑</label>
                                <input type="date" id="report-trip-start"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="col-span-2">
                                <label for="report-trip-end"
                                    class="block text-sm font-medium text-gray-700 mb-1">Âá∫Â∑ÆÊó•ÊúüËøÑ</label>
                                <input type="date" id="report-trip-end"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Row 4 -->
                            <div class="col-span-4">
                                <label for="report-receipt-count"
                                    class="block text-sm font-medium text-gray-700 mb-1">Á•®ÊìöÂºµÊï∏</label>
                                <input type="number" id="report-receipt-count" value="0" min="0"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-4">
                        <p class="text-sm font-bold text-gray-600">Â∑ÆÊóÖÁ¥ÄÈåÑË≥áÊñô</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="travel-date" class="block text-sm font-medium text-gray-700 mb-1">Êó•Êúü</label>
                                <input type="date" id="travel-date"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Â∑•‰ΩúË®òË¶Å
                                </label>
                                <input type="text" id="description" placeholder="‰æãÂ¶ÇÔºöÊîØÊè¥ÂàÜÈ§®"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div id="out-of-county-section" class="space-y-4 pt-4 border-t border-gray-200">
                            <p class="text-sm font-bold text-gray-600 bg-gray-100 p-2 rounded-md">Ë°åÁ®ã</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="start2" class="block text-sm font-medium text-gray-700 mb-1">Ëµ∑Èªû</label>
                                    <input type="text" id="start2" placeholder="Ë´ãËº∏ÂÖ•Ëµ∑Èªû"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="end2" class="block text-sm font-medium text-gray-700 mb-1">ÁµÇÈªû</label>
                                    <input type="text" id="end2" placeholder="Ë´ãËº∏ÂÖ•ÁµÇÈªû"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <div class="pt-2 flex flex-wrap gap-x-6 gap-y-2 border-t border-gray-200 mt-2 pt-2">
                            <div class="flex items-center">
                                <input id="transport-cost-toggle" type="checkbox" checked
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="transport-cost-toggle"
                                    class="ml-2 block text-sm font-medium text-gray-900">ÊòØÂê¶Áî≥Ë´ã‰∫§ÈÄöË≤ªÁî®Ôºü</label>
                            </div>


                            <div class="flex items-center">
                                <input id="misc-fee-toggle" type="checkbox"
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="misc-fee-toggle"
                                    class="ml-2 block text-sm font-medium text-gray-900">ÊòØÂê¶Áî≥Ë´ãÈõúË≤ªÔºü</label>
                            </div>
                            <div class="flex items-center">
                                <input id="lodging-fee-toggle" type="checkbox"
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="lodging-fee-toggle"
                                    class="ml-2 block text-sm font-medium text-gray-900">ÊòØÂê¶Áî≥Ë´ã‰ΩèÂÆøË≤ªÔºü</label>
                            </div>
                        </div>

                        <div id="transport-section" class="pt-2 border-t border-gray-100 grid grid-cols-2 gap-4">
                            <div>
                                <label for="transport-type"
                                    class="block text-sm font-medium text-gray-700 mb-1">‰∫§ÈÄöÂ∑•ÂÖ∑</label>
                                <select id="transport-type"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">

                                    <option value="Ë®àÁ®ãËªä">Ë®àÁ®ãËªä</option>
                                    <option value="Ê±ΩËªä">Ê±ΩËªä</option>
                                    <option value="ÁÅ´Ëªä">ÁÅ´Ëªä</option>
                                    <option value="È´òÈêµ">È´òÈêµ</option>
                                </select>
                            </div>
                            <div>
                                <label for="transport-cost"
                                    class="block text-sm font-medium text-gray-700 mb-1">‰∫§ÈÄöË≤ªÁî®</label>
                                <div class="relative"><span
                                        class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">NT$</span>
                                    <input type="number" id="transport-cost" value="0" min="0"
                                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <div id="misc-fee-section" class="hidden pt-2 border-t border-gray-100">
                            <div>
                                <label for="misc-fee-cost"
                                    class="block text-sm font-medium text-gray-700 mb-1">ÈõúË≤ªÈáëÈ°ç</label>
                                <div class="relative"><span
                                        class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">NT$</span>
                                    <input type="number" id="misc-fee-cost" value="0" min="0"
                                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <div id="lodging-fee-section" class="hidden pt-2 border-t border-gray-100">
                            <div>
                                <label for="lodging-fee-cost"
                                    class="block text-sm font-medium text-gray-700 mb-1">‰ΩèÂÆøË≤ªÈáëÈ°ç</label>
                                <div class="relative"><span
                                        class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">NT$</span>
                                    <input type="number" id="lodging-fee-cost" value="0" min="0"
                                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <div id="action-buttons" class="flex space-x-2 pt-2">
                            <button id="calculate-btn"
                                class="w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-blue-700 custom-btn">Ë®àÁÆóÂ∑ÆÊóÖË≤ª</button>
                            <button id="add-record-btn"
                                class="hidden w-1/2 bg-green-600 text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-green-700 custom-btn">Âä†ÂÖ•Á¥ÄÈåÑ</button>
                            <button id="modify-btn"
                                class="hidden w-1/2 bg-gray-500 text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-gray-600 custom-btn">‰øÆÊîπË≥áÊñô</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="error-message" class="hidden mt-4 text-center text-red-600 bg-red-100 p-3 rounded-lg"></div>

            <div id="results-preview" class="mt-6">
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-900 rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-2">Ë≤ªÁî®Ë®àÁÆóÈ†êË¶Ω</h3>
                    <div id="preview-details"></div>
                </div>
            </div>

            <div id="records-section" class="mt-10">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-700">Â∑ÆÊóÖÁ¥ÄÈåÑÂàóË°®</h2>
                    <div class="flex flex-wrap gap-2 items-center">
                        <div class="flex items-center gap-1 text-sm">
                            <label for="report-roc-year">Â†±Ë°®Âπ¥‰ªΩ(Ê∞ëÂúã):</label>
                            <input type="number" id="report-roc-year"
                                class="w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm">
                            <label for="report-month-start">Êúà‰ªΩÂæû:</label>
                            <input type="number" id="report-month-start" min="1" max="12"
                                class="w-16 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm">
                            <label for="report-month-end">Ëá≥:</label>
                            <input type="number" id="report-month-end" min="1" max="12"
                                class="w-16 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm">
                        </div>
                        <button id="generate-report-btn"
                            class="bg-sky-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-sky-600 custom-btn">Áî¢ÁîüÂ†±ÊîØÊ∏ÖÂñÆ</button>
                        <button id="import-csv-btn"
                            class="bg-blue-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-blue-600 custom-btn">ÂåØÂÖ•CSVÊ™îÊ°à</button>
                        <input type="file" id="csv-import-input" accept=".csv" class="hidden">
                        <button id="export-csv-btn"
                            class="bg-teal-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-teal-600 custom-btn">ÂåØÂá∫CSVÊ™îÊ°à</button>
                        <button id="clear-records-btn"
                            class="bg-red-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-red-600 custom-btn">Ê∏ÖÈô§ÊâÄÊúâÁ¥ÄÈåÑ</button>
                        <button id="screenshot-btn"
                            class="bg-gray-500 text-white font-bold p-2.5 rounded-lg hover:bg-gray-600 custom-btn flex items-center justify-center"
                            title="Êì∑ÂèñÁï´Èù¢Â≠òÊ™î">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="table-container bg-white rounded-lg shadow">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="py-3 px-6">Êó•Êúü</th>
                                <th scope="col" class="py-3 px-6">Â∑•‰ΩúË®òË¶Å</th>
                                <th scope="col" class="py-3 px-6">Ë∑ØÁ®ã</th>
                                <th scope="col" class="py-3 px-6 text-right">‰∫§ÈÄöÂ∑•ÂÖ∑</th>
                                <th scope="col" class="py-3 px-6 text-right">‰ΩèÂÆøË≤ª</th>
                                <th scope="col" class="py-3 px-6 text-right">ÈõúË≤ª</th>
                                <th scope="col" class="py-3 px-6 text-right">Â∞èË®à</th>
                                <th scope="col" class="py-3 px-6 text-center">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="records-body">
                            <tr class="bg-white">
                                <td colspan="8" class="py-6 px-6 text-center text-gray-400">Â∞öÁÑ°‰ªª‰ΩïÁ¥ÄÈåÑ</td>
                            </tr>
                        </tbody>
                        <tfoot class="font-semibold text-gray-800 bg-gray-200">
                            <tr>
                                <td colspan="7" class="py-3 px-6 text-right text-base">Á∏ΩË®àÈáëÈ°çÔºö</td>
                                <td id="grand-total" class="py-3 px-6 text-right text-xl text-green-600">NT$ 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <footer class="mt-8 mb-4 text-center text-gray-500 text-sm">
        <p>
            Êú¨Á≥ªÁµ±Áî± <strong>ÊõæÊòéÂÇë</strong> Ë®≠Ë®àÈñãÁôºÔºå<strong></strong>KNS hotelË≥áË®äË™≤</strong>‰øÆÊîπ
        </p>
    </footer>

    <div id="report-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full max-h-full overflow-auto">
            <div id="report-modal-content" class="text-black">
            </div>
            <div class="text-center mt-6 space-x-4">
                <button id="report-print-btn"
                    class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 custom-btn">ÂàóÂç∞Ê≠§Â†±Ë°®</button>
                <button id="report-close-btn"
                    class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 custom-btn">ÈóúÈñâ</button>
            </div>
        </div>
    </div>

    <script>
        // =========================================================
        // üè´ Â≠∏Ê†°Â∞àÂ±¨Ë®≠ÂÆöÂçÄ (ÂÖ∂‰ªñËÄÅÂ∏´Ë´ã‰øÆÊîπÈÄôË£°Âç≥ÂèØ)
        // =========================================================

        // 1. Â≠∏Ê†°ÂêçÁ®± (ÊúÉÈ°ØÁ§∫Âú®Á∂≤È†ÅÊ®ôÈ°åËàáÂ†±Ë°®‰∏≠)
        const SCHOOL_NAME = "Â∫∑Ê≠£ÊóÖÈ§®(ËÇ°)ÂÖ¨Âè∏";

        // 2. Â≠∏Ê†°ÂÆåÊï¥Âú∞ÂùÄ (È†êË®≠Ëµ∑ÈªûÂêçÁ®±)
        const SCHOOL_ADDRESS = "È´òÈõÑÂ∏ÇÊñ∞ËààÂçÄÂêåÊÑõË°ó30Ëôü";

        // 3. Â≠∏Ê†°Á∂ìÁ∑ØÂ∫¶Â∫ßÊ®ô (ÂèØÂú® Google Maps ‰∏äÂ∞çÂú∞ÈªûÊåâÂè≥ÈçµÂèñÂæóÔºöÂ∑¶ÈÇäÊòØlatÁ∑ØÂ∫¶, Âè≥ÈÇäÊòØlngÁ∂ìÂ∫¶)
        // Ê†ºÂºèÔºö{ lat: Á∑ØÂ∫¶, lng: Á∂ìÂ∫¶ }
        const SCHOOL_LOCATION = {
            lat: 22.656666,
            lng: 120.92051292679584
        };

        // =========================================================
        // ‚ö†Ô∏è ‰ª•‰∏ãÁ®ãÂºèÁ¢ºÂª∫Ë≠∞‰∏çË¶ÅÈö®ÊÑèÊõ¥ÂãïÔºå‰ª•ÂÖçÂäüËÉΩÁï∞Â∏∏
        // =========================================================

        let travelRecords = [];
        let currentCalculation = null;

        // Initialize on load
        window.addEventListener('load', init);

        function init() {
            // Ëá™ÂãïÊõ¥Êñ∞Á∂≤È†ÅÊ®ôÈ°åËàá H1
            document.getElementById('main-title').innerText = SCHOOL_NAME + " Âá∫Â∑ÆÊóÖË≤ªÂ†±ÂëäÁ≥ªÁµ±";
            document.title = SCHOOL_NAME + " Âá∫Â∑ÆÊóÖË≤ªÂ†±ÂëäÁ≥ªÁµ±";

            document.getElementById('travel-date').valueAsDate = new Date();

            // Set default report date
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('report-roc-year').value = currentYear - 1911;
            document.getElementById('report-month-start').value = currentMonth;
            document.getElementById('report-month-end').value = currentMonth;
        }

        function setPointData(type, lat, lng, statusText) {
            // Function functionality removed but keeping placeholder to avoid reference errors if any old code persists
        }

        document.getElementById('calculate-btn').addEventListener('click', calculateRoute);
        document.getElementById('add-record-btn').addEventListener('click', addRecord);
        document.getElementById('modify-btn').addEventListener('click', modifyCalculation);
        document.getElementById('screenshot-btn').addEventListener('click', takeScreenshot);
        document.getElementById('clear-records-btn').addEventListener('click', clearAllRecords);
        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
        document.getElementById('generate-report-btn').addEventListener('click', generateReport);
        document.getElementById('report-print-btn').addEventListener('click', () => window.print());
        document.getElementById('report-close-btn').addEventListener('click', () =>
            document.getElementById('report-modal').classList.add('hidden'));
        document.getElementById('import-csv-btn').addEventListener('click', () => document.getElementById('csv-import-input').click());
        document.getElementById('csv-import-input').addEventListener('change', handleCSVImport);


        // From home toggle and out of county toggle listeners removed

        // Out of county toggle listener removed

        document.getElementById('transport-cost-toggle').addEventListener('change', function () {
            const section = document.getElementById('transport-section');
            if (this.checked) {
                // Uncheck other toggles
                document.getElementById('misc-fee-toggle').checked = false;
                document.getElementById('misc-fee-section').classList.add('hidden');
                document.getElementById('misc-fee-section').style.display = 'none';
                document.getElementById('misc-fee-cost').value = '0';

                document.getElementById('lodging-fee-toggle').checked = false;
                document.getElementById('lodging-fee-section').classList.add('hidden');
                document.getElementById('lodging-fee-section').style.display = 'none';
                document.getElementById('lodging-fee-cost').value = '0';

                section.classList.remove('hidden');
                section.style.display = 'grid';
            } else {
                // Prevent unchecking if it's the only one checked
                const miscChecked = document.getElementById('misc-fee-toggle').checked;
                const lodgingChecked = document.getElementById('lodging-fee-toggle').checked;
                if (!miscChecked && !lodgingChecked) {
                    this.checked = true; // Re-check to ensure at least one is selected
                    return;
                }
                section.classList.add('hidden');
                section.style.display = 'none';
                document.getElementById('transport-type').value = '1';
                document.getElementById('transport-cost').value = '0';
            }
        });

        document.getElementById('misc-fee-toggle').addEventListener('change', function () {
            const section = document.getElementById('misc-fee-section');
            if (this.checked) {
                // Uncheck other toggles
                document.getElementById('transport-cost-toggle').checked = false;
                document.getElementById('transport-section').classList.add('hidden');
                document.getElementById('transport-section').style.display = 'none';
                document.getElementById('transport-type').value = '1';
                document.getElementById('transport-cost').value = '0';

                document.getElementById('lodging-fee-toggle').checked = false;
                document.getElementById('lodging-fee-section').classList.add('hidden');
                document.getElementById('lodging-fee-section').style.display = 'none';
                document.getElementById('lodging-fee-cost').value = '0';

                section.classList.remove('hidden');
                section.style.display = 'block';
            } else {
                // Prevent unchecking if it's the only one checked
                const transportChecked = document.getElementById('transport-cost-toggle').checked;
                const lodgingChecked = document.getElementById('lodging-fee-toggle').checked;
                if (!transportChecked && !lodgingChecked) {
                    this.checked = true; // Re-check to ensure at least one is selected
                    return;
                }
                section.classList.add('hidden');
                section.style.display = 'none';
                document.getElementById('misc-fee-cost').value = '0';
            }
        });
        document.getElementById('lodging-fee-toggle').addEventListener('change', function () {
            const section = document.getElementById('lodging-fee-section');
            if (this.checked) {
                // Uncheck other toggles
                document.getElementById('transport-cost-toggle').checked = false;
                document.getElementById('transport-section').classList.add('hidden');
                document.getElementById('transport-section').style.display = 'none';
                document.getElementById('transport-type').value = '1';
                document.getElementById('transport-cost').value = '0';

                document.getElementById('misc-fee-toggle').checked = false;
                document.getElementById('misc-fee-section').classList.add('hidden');
                document.getElementById('misc-fee-section').style.display = 'none';
                document.getElementById('misc-fee-cost').value = '0';

                section.classList.remove('hidden');
                section.style.display = 'block';
            } else {
                // Prevent unchecking if it's the only one checked
                const transportChecked = document.getElementById('transport-cost-toggle').checked;
                const miscChecked = document.getElementById('misc-fee-toggle').checked;
                if (!transportChecked && !miscChecked) {
                    this.checked = true; // Re-check to ensure at least one is selected
                    return;
                }
                section.classList.add('hidden');
                section.style.display = 'none';
                document.getElementById('lodging-fee-cost').value = '0';
            }
        });
        document.getElementById('records-body').addEventListener('click', e => {
            if (e.target.classList.contains('delete-btn')) {
                const recordId = parseInt(e.target.dataset.id, 10);
                deleteRecord(recordId);
            }
        });

        // Êï∏Â≠óËΩâÂ§ßÂØ´‰∏≠Êñá
        function numberToChinese(n) {
            const fraction = ['Ëßí', 'ÂàÜ'];
            const digit = ['Èõ∂', 'Â£π', 'Ë≤≥', 'ÂèÉ', 'ËÇÜ', '‰ºç', 'Èô∏', 'Êüí', 'Êçå', 'Áéñ'];
            const unit = [['ÂÖÉ', 'Ëê¨', 'ÂÑÑ'], ['', 'Êãæ', '‰Ω∞', '‰ªü']];
            let head = n < 0 ? 'Ê¨†' : '';
            n = Math.abs(n);
            let s = '';
            for (let i = 0; i < fraction.length; i++) {
                s += (digit[Math.floor(Math.round(n * 10 * Math.pow(10, i))) % 10] + fraction[i]).replace(/Èõ∂./, '');
            }
            s = s || 'Êï¥';
            n = Math.floor(n);
            for (let i = 0; i < unit[0].length && n > 0; i++) {
                let p = '';
                for (let j = 0; j < unit[1].length && n > 0; j++) {
                    p = digit[n % 10] + unit[1][j] + p;
                    n = Math.floor(n / 10);
                }
                s = p.replace(/(Èõ∂.)*Èõ∂$/, '').replace(/^$/, 'Èõ∂') + unit[0][i] + s;
            }
            return head + s.replace(/(Èõ∂.)*Èõ∂ÂÖÉ/, 'ÂÖÉ')
                .replace(/(Èõ∂.)+/g, 'Èõ∂')
                .replace(/^Êï¥$/, 'Èõ∂ÂÖÉÊï¥');
        }

        function numberToChinese2(num) {
            if (num === 0) return "Èõ∂ÂÖÉÊï¥";

            const digits = ["Èõ∂", "Â£π", "Ë≤≥", "ÂèÉ", "ËÇÜ", "‰ºç", "Èô∏", "Êüí", "Êçå", "Áéñ"];

            // ÂÆöÁæ©ÊØè‰∏Ä‰ΩçÊï∏ÁöÑÁµïÂ∞çÂñÆ‰Ωç
            const units = [
                { unit: "ÂÖÉ", val: 1 },
                { unit: "Êãæ", val: 10 },
                { unit: "‰Ω∞", val: 100 },
                { unit: "‰ªü", val: 1000 },
                { unit: "Ëê¨", val: 10000 },
                { unit: "ÊãæËê¨", val: 100000 },
                { unit: "‰Ω∞Ëê¨", val: 1000000 },
                { unit: "‰ªüËê¨", val: 10000000 },
                { unit: "ÂÑÑ", val: 100000000 }
            ];

            let result = "";
            let tempNum = num;

            // ÂæûÊúÄÈ´òÂñÆ‰ΩçÈñãÂßãÂæÄÂõûË∑ë
            for (let i = units.length - 1; i >= 0; i--) {
                let currentUnit = units[i];
                let count = Math.floor(tempNum / currentUnit.val);

                if (count > 0) {
                    // Â¶ÇÊûúÊòØËê¨‰Ωç‰ª•‰∏äÁöÑ„ÄåÊãæ„ÄçÔºåÂº∑Âà∂È°ØÁ§∫ÁÇ∫„ÄåÂ£πÊãæ„Äç
                    // ÈÄôË£°ÊúÉÂ∞á 110,000 ÊãÜËß£ÁÇ∫ 1ÂÄãÊãæËê¨ + 1ÂÄãËê¨
                    result += digits[count] + currentUnit.unit;
                    tempNum %= currentUnit.val;
                }
            }

            // ËôïÁêÜÁµêÂ∞æ
            if (!result.endsWith("ÂÖÉ")) {
                result += "ÂÖÉ";
            }

            return result + "Êï¥";
        }



        // Ê†ºÂºèÂåñÁÇ∫‰∏≠ËèØÊ∞ëÂúãÊó•Êúü
        function formatROCDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            const y = date.getFullYear() - 1911;
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            return `${y} Âπ¥ ${m} Êúà ${d} Êó•`;
        }

        // Êô∫ÊÖßÂú∞ÂùÄ‰øÆÊ≠£ÂäüËÉΩ
        function preprocessAddress(address) {
            if (!address) return '';

            // ÁßªÈô§ÂèØËÉΩÈáçË§áËº∏ÂÖ•ÁöÑ "Âè∞ÁÅ£"
            let processed = address.replace(/^Âè∞ÁÅ£\s*/, '').replace(/^Taiwan\s*/, '');

            // Â∏∏Ë¶ãÂè£Ë™ûÂú∞Âêç -> OSM Ê≠£ÂºèÂêçÁ®±Â∞çÁÖßË°®
            const hsrMap = {
                'Âè∞‰∏≠È´òÈêµ': 'È´òÈêµÂè∞‰∏≠Á´ô',
                'Ëá∫‰∏≠È´òÈêµ': 'È´òÈêµÂè∞‰∏≠Á´ô',
                'ÁÉèÊó•È´òÈêµ': 'È´òÈêµÂè∞‰∏≠Á´ô',
                'Êñ∞ÁÉèÊó•È´òÈêµ': 'È´òÈêµÂè∞‰∏≠Á´ô',
                'Âè∞ÂåóÈ´òÈêµ': 'Âè∞ÂåóËªäÁ´ô',
                'Ëá∫ÂåóÈ´òÈêµ': 'Âè∞ÂåóËªäÁ´ô',
                'ÊùøÊ©ãÈ´òÈêµ': 'ÊùøÊ©ãËªäÁ´ô',
                'Ê°ÉÂúíÈ´òÈêµ': 'È´òÈêµÊ°ÉÂúíÁ´ô',
                'Êñ∞Á´πÈ´òÈêµ': 'È´òÈêµÊñ∞Á´πÁ´ô',
                'ÂÖ≠ÂÆ∂È´òÈêµ': 'È´òÈêµÊñ∞Á´πÁ´ô',
                'Á´πÂåóÈ´òÈêµ': 'È´òÈêµÊñ∞Á´πÁ´ô',
                'ËãóÊ†óÈ´òÈêµ': 'È´òÈêµËãóÊ†óÁ´ô',
                'ÂæåÈæçÈ´òÈêµ': 'È´òÈêµËãóÊ†óÁ´ô',
                'ÂΩ∞ÂåñÈ´òÈêµ': 'È´òÈêµÂΩ∞ÂåñÁ´ô',
                'Áî∞‰∏≠È´òÈêµ': 'È´òÈêµÂΩ∞ÂåñÁ´ô',
                'Èõ≤ÊûóÈ´òÈêµ': 'È´òÈêµÈõ≤ÊûóÁ´ô',
                'ËôéÂ∞æÈ´òÈêµ': 'È´òÈêµÈõ≤ÊûóÁ´ô',
                'ÂòâÁæ©È´òÈêµ': 'È´òÈêµÂòâÁæ©Á´ô',
                'Â§™‰øùÈ´òÈêµ': 'È´òÈêµÂòâÁæ©Á´ô',
                'Âè∞ÂçóÈ´òÈêµ': 'È´òÈêµÂè∞ÂçóÁ´ô',
                'Ëá∫ÂçóÈ´òÈêµ': 'È´òÈêµÂè∞ÂçóÁ´ô',
                'Ê≤ôÂ¥ôÈ´òÈêµ': 'È´òÈêµÂè∞ÂçóÁ´ô',
                'Â∑¶ÁáüÈ´òÈêµ': 'È´òÈêµÂ∑¶ÁáüÁ´ô',
                'È´òÈõÑÈ´òÈêµ': 'È´òÈêµÂ∑¶ÁáüÁ´ô'
            };

            for (const [key, value] of Object.entries(hsrMap)) {
                if (processed.includes(key)) {
                    // Â¶ÇÊûúÁî®Êà∂Ëº∏ÂÖ•ÂåÖÂê´ÈóúÈçµÂ≠óÔºåÊõøÊèõÊàêÊ≠£ÂºèÂêçÁ®±
                    return value;
                }
            }
            return processed;
        }

        async function getOSRMRoute(startCoords, endCoords) {
            try {
                const url =
                    `https://router.project-osrm.org/route/v1/driving/${startCoords.lng},${startCoords.lat};${endCoords.lng},${endCoords.lat}?overview=full&geometries=geojson`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.code === 'Ok' && data.routes.length > 0) {
                    return data.routes[0];
                }
                return null;
            } catch (e) {
                console.error("Routing error:", e);
                return null;
            }
        }

        async function calculateRoute() {
            showError('');
            const calculateBtn = document.getElementById('calculate-btn');
            const originalBtnText = calculateBtn.innerText;
            calculateBtn.innerText = 'Ë®àÁÆó‰∏≠...';
            calculateBtn.disabled = true;

            const isFromHome = false;

            const transportType = document.getElementById('transport-type').value;
            const transportCost = parseInt(document.getElementById('transport-cost').value, 10) || 0;
            const applyMiscFee = document.getElementById('misc-fee-toggle').checked;
            const miscFee = applyMiscFee ? (parseInt(document.getElementById('misc-fee-cost').value, 10)
                || 0) : 0;
            const applyLodgingFee = document.getElementById('lodging-fee-toggle').checked;
            const lodgingFee = applyLodgingFee ?
                (parseInt(document.getElementById('lodging-fee-cost').value, 10) || 0) : 0;

            const start2 = document.getElementById('start2').value || '';
            const end2 = document.getElementById('end2').value || '';

            try {
                currentCalculation = {
                    id: Date.now(),
                    date: document.getElementById('travel-date').value,
                    description: document.getElementById('description').value || 'Êú™Â°´ÂØ´',
                    isFromHome,
                    leg1: { start: '', end: '', distance: 0, cost: 0 },
                    leg2: { start: start2, end: end2, distance: 0, cost: 0 },
                    transportType: transportType,
                    transportCost: transportCost,
                    miscFee: miscFee,
                    lodgingFee: lodgingFee,
                };

                const totalCost = calculateTotalCost(currentCalculation);
                currentCalculation.totalCost = totalCost;

                displayPreview(currentCalculation);
                document.getElementById('calculate-btn').classList.add('hidden');
                document.getElementById('add-record-btn').classList.remove('hidden');
                document.getElementById('modify-btn').classList.remove('hidden');

            } catch (error) {
                showError('ÁôºÁîüÈåØË™§: ' + error.message);
                currentCalculation = null;
            } finally {
                calculateBtn.innerText = originalBtnText;
                calculateBtn.disabled = false;
            }
        }

        function displayPreview(calc) {
            const previewDetails = document.getElementById('preview-details');
            let content = '<div class="space-y-2">';
            if (calc.transportCost > 0) {
                content += `
                                <div class="p-2 bg-white/60 rounded-md">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-gray-800">${calc.transportType}Ë≤ªÁî®</span>
                                        <span class="font-bold text-blue-700">NT$
                                            ${calc.transportCost.toLocaleString()}</span>
                                    </div>
                                </div>`;
            }
            if (calc.lodgingFee > 0) {
                content += `
                                <div class="p-2 bg-white/60 rounded-md">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-gray-800">‰ΩèÂÆøË≤ª</span>
                                        <span class="font-bold text-blue-700">NT$
                                            ${calc.lodgingFee.toLocaleString()}</span>
                                    </div>
                                </div>`;
            }
            if (calc.miscFee > 0) {
                content += `
                                <div class="p-2 bg-white/60 rounded-md">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-gray-800">ÈõúË≤ª</span>
                                        <span class="font-bold text-blue-700">NT$
                                            ${calc.miscFee.toLocaleString()}</span>
                                    </div>
                                </div>`;
            }
            content += `
                                <div class="text-right border-t border-blue-200 pt-2 mt-2">
                                    <p class="text-sm font-semibold">Ë≤ªÁî®Á∏ΩË®à</p>
                                    <p class="text-xl font-bold text-green-600">NT$ ${calc.totalCost.toLocaleString()}
                                    </p>
                                </div>`;
            content += '</div>'; // Correctly close the initial 'space-y-2' div
            previewDetails.innerHTML = content;
            document.getElementById('results-preview').classList.add('show');
        }

        function addRecord() {
            if (!currentCalculation) return;
            travelRecords.push(currentCalculation);
            renderRecords();
            clearInputFields();
            resetActionButtons();
        }

        function modifyCalculation() {
            document.getElementById('results-preview').classList.remove('show');
            resetActionButtons();
            currentCalculation = null;
        }

        function resetActionButtons() {
            document.getElementById('calculate-btn').classList.remove('hidden');
            document.getElementById('add-record-btn').classList.add('hidden');
            document.getElementById('modify-btn').classList.add('hidden');
        }

        function calculateTotalCost(record) {
            return (record.transportCost || 0) + (record.miscFee || 0) + (record.lodgingFee || 0);
        }

        function simplifyAddress(address) {
            return address || '';
        }


        function renderRecords() {
            const recordsBody = document.getElementById('records-body');
            const grandTotalCell = document.getElementById('grand-total');
            recordsBody.innerHTML = '';

            if (travelRecords.length === 0) {
                recordsBody.innerHTML = `<tr class="bg-white">
                                <td colspan="8" class="py-6 px-6 text-center text-gray-400">Â∞öÁÑ°‰ªª‰ΩïÁ¥ÄÈåÑ</td>
                            </tr>`;
                grandTotalCell.textContent = 'NT$ 0';
                return;
            }

            let grandTotal = 0;
            travelRecords.forEach(record => {
                grandTotal += record.totalCost;
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';

                const startDisplay = simplifyAddress(record.leg1.start || (record.leg2 ? record.leg2.start :
                    ''), record.isFromHome);
                const endDisplay = simplifyAddress((record.leg2 ? record.leg2.end : '') || record.leg1.end);

                let routeHtml = ``;
                if (startDisplay && endDisplay) {
                    routeHtml += `<div>${startDisplay} ‚Üí ${endDisplay}</div>`;
                }
                if (record.leg2 && record.leg2.start) {
                    routeHtml += `<div class="text-xs text-gray-500 mt-1">${simplifyAddress(record.leg2.start)}
                                ‚Üí ${simplifyAddress(record.leg2.end)}</div>`;
                }
                if (!routeHtml) routeHtml = `<div class="text-gray-400">ÁÑ°Ë∑ØÁ®ãÁ¥ÄÈåÑ</div>`;
                const publicTransportSum = (record.hsrCost || 0) + (record.trainCost || 0);

                row.innerHTML = `
                            <td class="py-4 px-6">${record.date}</td>
                            <td class="py-4 px-6 font-medium text-gray-900">${record.description}</td>
                            <td class="py-4 px-6">${routeHtml}</td>
                            <td class="py-4 px-6 text-right">${record.transportType || 'ÁÑ°'}: NT$ ${(record.transportCost
                        || 0).toLocaleString()}</td>
                            <td class="py-4 px-6 text-right">${(record.lodgingFee || 0).toLocaleString()}</td>
                            <td class="py-4 px-6 text-right">${(record.miscFee || 0).toLocaleString()}</td>
                            <td class="py-4 px-6 text-right font-semibold">${record.totalCost.toLocaleString()}</td>
                            <td class="py-4 px-6 text-center">
                                <button class="delete-btn text-red-600 hover:text-red-900 font-medium"
                                    data-id="${record.id}">Âà™Èô§</button>
                            </td>
                            `;
                recordsBody.appendChild(row);
            });
            grandTotalCell.textContent = `NT$ ${grandTotal.toLocaleString()}`;
        }

        function deleteRecord(recordId) {
            travelRecords = travelRecords.filter(r => r.id !== recordId);
            renderRecords();
        }

        function clearAllRecords() {
            travelRecords = [];
            renderRecords();
        }

        function clearInputFields() {
            document.getElementById('description').value = '';
            //document.getElementById('start2').value = '';
            //document.getElementById('end2').value = '';

            // Clear coordinates and status texts


            document.getElementById('transport-cost-toggle').checked = true;
            document.getElementById('transport-section').classList.remove('hidden');
            document.getElementById('transport-section').style.display = 'grid';
            document.getElementById('transport-type').value = 'Ë®àÁ®ãËªä';
            document.getElementById('transport-cost').value = '0';

            document.getElementById('misc-fee-toggle').checked = false;
            document.getElementById('misc-fee-section').classList.add('hidden');
            document.getElementById('misc-fee-section').style.display = 'none';
            document.getElementById('misc-fee-cost').value = '0';

            document.getElementById('lodging-fee-toggle').checked = false;
            document.getElementById('lodging-fee-section').classList.add('hidden');
            document.getElementById('lodging-fee-section').style.display = 'none';
            document.getElementById('lodging-fee-cost').value = '0';


            //document.getElementById('travel-date').valueAsDate = new Date();
            document.getElementById('results-preview').classList.remove('show');
            currentCalculation = null;
        }

        function exportToCSV() {
            if (travelRecords.length === 0) return alert('Ê≤íÊúâÁ¥ÄÈåÑÂèØ‰æõÂåØÂá∫„ÄÇ');
            const headers = [
                'id', 'date', 'description', 'route', 'transportType', 'transportCost', 'lodgingFee', 'miscFee',
                'isFromHome', 'totalCost'
            ];
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(',') + '\n';
            travelRecords.forEach(r => {
                const startDisplay = simplifyAddress(r.leg1.start || (r.leg2 ? r.leg2.start : ''), r.isFromHome);
                const endDisplay = simplifyAddress((r.leg2 ? r.leg2.end : '') || r.leg1.end);
                let routeText = `${startDisplay} ‚Üí ${endDisplay}`;
                if (r.leg2 && r.leg2.start) {
                    routeText += ` | ${simplifyAddress(r.leg2.start)} ‚Üí ${simplifyAddress(r.leg2.end)}`;
                }

                const row = [
                    r.id, r.date, `"${r.description}"`, `"${routeText}"`,
                    `"${r.transportType || 'ÁÑ°'}"`, r.transportCost || 0, r.lodgingFee || 0, r.miscFee || 0,
                    r.isFromHome ? 1 : 0, r.totalCost
                ].join(',');
                csvContent += row + '\n';
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const currentDate = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `Â∑ÆÊóÖË≤ªÁî®Á¥ÄÈåÑ - ${currentDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length <= 1) { showError('Ê™îÊ°àÁÇ∫Á©∫ÊàñÊ†ºÂºè‰∏çÁ¨¶„ÄÇ'); return; }
                const headers = lines[0].split(',').map(h => h.trim());
                const headerMap = headers.reduce((obj, h, i) => { obj[h] = i; return obj; }, {});
                if (!('id' in headerMap && 'totalCost' in headerMap)) { showError('ÂåØÂÖ•Â§±ÊïóÔºöCSV Ê™îÊ°àÁº∫Â∞ëÂøÖË¶ÅÊ¨Ñ‰Ωç„ÄÇ'); return; }

                const importedRecords = [];
                try {
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, ''));
                        if (values.length !== headers.length) continue;

                        const routeStr = values[headerMap['route']] || '';
                        let leg1 = { start: '', end: '', distance: 0, cost: 0 };
                        let leg2 = { start: '', end: '', distance: 0, cost: 0 };

                        if (routeStr) {
                            const splitRegex = /[‚Üí]|->|>/;
                            const legs = routeStr.split('|').map(s => s.trim());
                            if (legs[0]) {
                                const parts = legs[0].split(splitRegex).map(s => s.trim());
                                leg1.start = parts[0] || '';
                                leg1.end = parts[1] || '';
                            }
                            if (legs[1]) {
                                const parts = legs[1].split(splitRegex).map(s => s.trim());
                                leg2.start = parts[0] || '';
                                leg2.end = parts[1] || '';
                            }
                        }

                        const record = {
                            id: parseInt(values[headerMap['id']], 10) || Date.now() + i,
                            date: values[headerMap['date']],
                            description: values[headerMap['description']],
                            leg1: leg1,
                            leg2: leg2,
                            transportType: values[headerMap['transportType']] || 'ÁÑ°',
                            transportCost: parseInt(values[headerMap['transportCost']], 10) || 0,
                            lodgingFee: parseInt(values[headerMap['lodgingFee']], 10) || 0,
                            miscFee: parseInt(values[headerMap['miscFee']], 10) || 0,
                            isFromHome: values[headerMap['isFromHome']] === '1',
                            totalCost: parseInt(values[headerMap['totalCost']], 10) || 0
                        };
                        importedRecords.push(record);
                    }
                    travelRecords.push(...importedRecords);
                    renderRecords();
                } catch (err) { showError('ÂåØÂÖ•Â§±ÊïóÔºö' + err.message); }
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        function generateReport() {



            if (travelRecords.length === 0) {
                let answer = confirm('Ê≤íÊúâÁ¥ÄÈåÑÂèØ‰æõÁî¢ÁîüÂ†±Ë°®ÔºåÊòØÂê¶ÁπºÁ∫åÁî¢ÁîüÁ©∫ÁôΩÂ†±Ë°®Ôºü');
                if (!answer) {

                    return;
                }
                else {
                    document.getElementById('report-job-title').value = '';
                    document.getElementById('report-name').value = '';
                    document.getElementById('report-trip-location').value = '';
                    document.getElementById('report-trip-reason').value = '';
                    document.getElementById('report-trip-start').value = '';
                    document.getElementById('report-trip-end').value = '';


                }
            }

            const contentDiv = document.getElementById('report-modal-content');
            let totalLodgingFee = 0;
            let totalMiscFee = 0;
            let totalTransportCost = 0;
            let grandTotal = 0;
            let tableRows = '';
            for (let i = 0; i < 6; i++) {
                const r = travelRecords[i]; if (r) {
                    let
                        displayMonth = '', displayDay = ''; if (r.date) {
                            const parsedDate = new
                                Date(r.date); if (!isNaN(parsedDate.getTime())) {
                                    displayMonth = parsedDate.getMonth() + 1; displayDay = parsedDate.getDate();
                                }
                        }
                    totalLodgingFee += r.lodgingFee || 0;
                    totalMiscFee += r.miscFee || 0;
                    const tCost = r.transportCost || 0;
                    totalTransportCost += tCost;
                    grandTotal += r.totalCost;
                    const leg1Start = r.leg1 &&
                        r.leg1.start ? r.leg1.start : ''; const leg1End = r.leg1 && r.leg1.end ?
                            r.leg1.end : ''; const leg2Start = (r.leg2 && r.leg2.start) ? r.leg2.start : '';
                    const leg2End = (r.leg2 && r.leg2.end) ? r.leg2.end : ''; const
                        startDisplay = simplifyAddress(leg1Start || leg2Start, r.isFromHome); const
                            finalEndDisplay = simplifyAddress(leg2End || leg1End); tableRows += ` <tr
                                        class="text-center">
                                        <td>${displayMonth}</td>
                                        <td>${displayDay}</td>
                                        <td>${startDisplay}‚Üí${finalEndDisplay}</td>
                                        <td class="text-left px-2">${r.description}</td>
                                        <td>${r.transportType || 'ÁÑ°'}</td>
                                        <td>${tCost > 0 ? tCost.toLocaleString() : ''}</td>
                                        <td>${r.lodgingFee > 0 ? r.lodgingFee.toLocaleString() : ''}</td>
                                        <td>${r.miscFee > 0 ? r.miscFee.toLocaleString() : ''}</td>
                                        <td>${r.totalCost.toLocaleString()}</td>
                                        <td></td>
                                        </tr>`;
                } else {
                    tableRows += `<tr>
                                            <td>&nbsp;</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>`;
                }
            }
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            const inputRocYear = document.getElementById('report-roc-year').value ||
                (currentYear - 1911);
            const inputMonthStart = document.getElementById('report-month-start').value ||
                currentMonth;
            const inputMonthEnd = document.getElementById('report-month-end').value ||
                inputMonthStart;
            let monthDisplay = `${inputMonthStart} Êúà‰ªΩ`;
            if (inputMonthStart !== inputMonthEnd) monthDisplay = `${inputMonthStart} Êúà Ëá≥
                                        ${inputMonthEnd} Êúà‰ªΩ`;

            const reportJobTitle = document.getElementById('report-job-title').value || '';
            const reportName = document.getElementById('report-name').value || '';
            const reportTripReason = document.getElementById('report-trip-reason').value ||
                '';
            const reportTripLocation = document.getElementById('report-trip-location').value
                || '';
            const reportTripStartStr = document.getElementById('report-trip-start').value;
            const reportTripEndStr = document.getElementById('report-trip-end').value;
            const reportTripStart = formatROCDate(reportTripStartStr);
            const reportTripEnd = formatROCDate(reportTripEndStr);
            const reportReceiptCount = document.getElementById('report-receipt-count').value
                || '0';

            let dayCountDisplay = '';
            if (reportTripStartStr && reportTripEndStr) {
                const start = new Date(reportTripStartStr);
                const end = new Date(reportTripEndStr);
                if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    dayCountDisplay = ` ÂÖ±Ë®à ${diffDays} Êó•`;
                }
            }

            contentDiv.innerHTML = `
                                        <div class="text-center space-y-2 mb-4">
                                            <h2 class="text-2xl font-bold">${SCHOOL_NAME}</h2>
                                            <h3 class="text-xl font-bold">Âá∫Â∑ÆÊóÖË≤ªÂ†±ÂëäË°®</h3>
                                        </div>



                                        <table class="w-full border-collapse text-sm mb-4">
                                            <tr class="text-left font-bold">
                                                <td class="w-24 bg-gray-50">ËÅ∑Âà•</td>
                                                <td>${reportJobTitle}</td>
                                                <td class="w-24 bg-gray-50">ÂßìÂêç</td>
                                                <td class="w-24 bg-gray-50">${reportName}</td>
                                            </tr>
                                            <tr class="text-left font-bold">
                                                <td class="bg-gray-50">Âá∫Â∑Æ‰∫ãÁî±</td>
                                                <td>${reportTripReason}</td>
                                                <td class="bg-gray-50">Âá∫Â∑ÆÂú∞Èªû</td>
                                                <td>${reportTripLocation}</td>
                                            </tr>
                                            <tr class="text-left font-bold">
                                                <td class="bg-gray-50">Âá∫Â∑ÆÊó•Êúü</td>
                                                <td colspan="3">‰∏≠ËèØÊ∞ëÂúã${reportTripStart !== '' ? reportTripStart : '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Âπ¥&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Êúà&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Êó•'}Ëµ∑ Ëá≥
                                                    ${reportTripEnd !== '' ? reportTripEnd : '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Âπ¥&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Êúà&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Êó•'}Ê≠¢
                                                    ${dayCountDisplay !== '' ? dayCountDisplay : 'ÂÖ±Ë®à &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Êó•'}
                                                    ÈôÑÂñÆÊìöÔºö${reportReceiptCount > 0 ? reportReceiptCount : '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '}Âºµ</td>
                                            </tr>
                                        </table>
                                        <table class="w-full border-collapse text-sm">
                                            <thead>
                                                <tr class="text-center font-bold">
                                                    <td colspan="2">Êó•Êúü</td>
                                                    <td rowspan="2" class="w-24">Ëµ∑Ë®ñÂú∞Èªû</td>
                                                    <td rowspan="2" class="w-48">Â∑•‰ΩúË®òË¶Å</td>
                                                    <td class="w-14" rowspan="2">‰∫§ÈÄö<br>Â∑•ÂÖ∑</td>
                                                    <td rowspan="2" class="w-24">ÈáëÈ°ç</td>
                                                    <td rowspan="2" class="w-24">‰ΩèÂÆøË≤ª</td>
                                                    <td rowspan="2" class="w-24">ÈõúË≤ª</td>
                                                    <td rowspan="2" class="w-24">Á∏ΩË®à</td>
                                                    <td rowspan="2" class="w-24">ÂÇôË®ª</td>
                                                </tr>
                                                <tr class="text-center font-bold">
                                                    <td class="w-10">Êúà</td>
                                                    <td class="w-10">Êó•</td>

                                                </tr>

                                            </thead>
                                            <tbody>${tableRows}</tbody>
                                            <tfoot>
                                                <tr class="text-center font-bold">
                                                    <td colspan="2">Âêà Ë®à</td>
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td>${totalTransportCost > 0 ? totalTransportCost.toLocaleString() : ''}</td>
                                                    <td>${totalLodgingFee > 0 ? totalLodgingFee.toLocaleString() : ''}
                                                    </td>
                                                    <td>${totalMiscFee > 0 ? totalMiscFee.toLocaleString() : ''}</td>
                                                    <td>${grandTotal > 0 ? grandTotal.toLocaleString() : ''}</td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="10" class="text-left align-top p-2"
                                                        style="min-height: 4em; vertical-align: top;">
                                                        Ëå≤Êî∂Âà∞Âá∫Â∑ÆÊóÖË≤ª&nbsp;&nbsp;Êñ∞Âè∞Âπ£ <span
                                                            class="font-bold">${grandTotal > 0 ? numberToChinese2(grandTotal) : '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ÊãæËê¨&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ëê¨&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‰ªü&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Áôæ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Êãæ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ÂÖÉÊï¥'}</span> 
                                                         <span class="font-bold">${grandTotal > 0 ? '(NT$' + grandTotal.toLocaleString() + 'ÂÖÉÊï¥)' : ''}</span>

                                                        <br>ÂÖ∑È†ò‰∫∫Ôºö&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(${formatROCDate(new
                Date().toISOString().split('T')[0])})
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                        <div class="flex justify-between text-sm mt-4 pt-4">
                                            <span>Ê†∏ÂáÜ‰∏ªÁÆ°Ôºö</span>
                                            <span>ÊúÉË®àÔºö</span>
                                            <span>Âá∫Á¥çÔºö</span>
                                            <span>Âá∫Â∑Æ‰∫∫Ôºö&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                        </div>
                                        `;
            document.getElementById('report-modal').classList.remove('hidden');
        }

        async function takeScreenshot() {
            const screenshotBtn = document.getElementById('screenshot-btn');
            const originalBtnContent = screenshotBtn.innerHTML;
            screenshotBtn.disabled = true;
            screenshotBtn.innerHTML = `<svg class="animate-spin h-5 w-5"
                                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor"
                                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                            </path>
                                        </svg>`;
            await new Promise(resolve => setTimeout(resolve, 1000));
            try {
                const canvas = await html2canvas(document.getElementById('capture-area'), {
                    useCORS: true, allowTaint: true, scale: 1.5
                });
                const link = document.createElement('a');
                link.download = `Â∑ÆÊóÖË≤ªÁî®Á¥ÄÈåÑ - ${new Date().toISOString().slice(0, 10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) { showError('Êà™ÂúñÂ§±Êïó„ÄÇ'); }
            finally {
                screenshotBtn.disabled = false; screenshotBtn.innerHTML =
                    originalBtnContent;
            }
        }

        function showError(message) {
            const errorMessageDiv = document.getElementById('error-message');
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.toggle('hidden', !message);
        }
    </script>
</body>

</html>
